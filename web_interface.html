<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investor Network Database Browser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }
        .search-form {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #4299e1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #3182ce;
        }
        .results {
            margin-top: 20px;
        }
        .investor-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .investor-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        .investor-firm {
            color: #4299e1;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .investor-metrics {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .metric {
            background: #edf2f7;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .linkedin-link {
            color: #0077b5;
            text-decoration: none;
        }
        .linkedin-link:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .error {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Investor Network Database Browser</h1>
        
        <div id="stats" class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">Loading...</div>
                <div class="stat-label">Database Statistics</div>
            </div>
        </div>

        <div class="search-form">
            <h3>üîç Search Investors</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label>Firm Name</label>
                    <input type="text" id="firmName" placeholder="e.g., Sequoia Capital">
                </div>
                <div class="form-group">
                    <label>Min Connections</label>
                    <input type="number" id="minConnections" placeholder="e.g., 1000">
                </div>
                <div class="form-group">
                    <label>Network Tier</label>
                    <select id="networkTier">
                        <option value="">All Tiers</option>
                        <option value="Super Connected">Super Connected</option>
                        <option value="Highly Connected">Highly Connected</option>
                        <option value="Well Connected">Well Connected</option>
                        <option value="Connected">Connected</option>
                        <option value="Limited Network">Limited Network</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>LinkedIn Required</label>
                    <select id="hasLinkedIn">
                        <option value="">Any</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
            </div>
            <button onclick="searchInvestors()" style="margin-top: 15px;">Search Investors</button>
            <button onclick="getTopInvestors()" style="margin-left: 10px;">Get Top Connected</button>
        </div>

        <div id="results" class="results">
            <!-- Results will be loaded here -->
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3010/api';

        // Enhanced error handling to prevent blank screen
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <strong>JavaScript Error:</strong> ${e.error.message}<br>
                <small>Check console for details</small>
            `;
            document.body.insertBefore(errorDiv, document.body.firstChild);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <strong>Network/API Error:</strong> ${e.reason}<br>
                <small>Check if server is running</small>
            `;
            document.body.insertBefore(errorDiv, document.body.firstChild);
        });

        // Check if we can reach the server
        async function checkServerHealth() {
            try {
                const response = await fetch('/health', { timeout: 5000 });
                const health = await response.json();
                console.log('Server health:', health);
                return health;
            } catch (error) {
                console.error('Server health check failed:', error);
                return null;
            }
        }

        // Load initial stats
        async function loadStats() {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = '<div class="loading">Loading database statistics...</div>';
            
            try {
                console.log('Fetching stats from:', `${API_BASE}/network/stats`);
                
                // First check server health
                const health = await checkServerHealth();
                if (!health) {
                    throw new Error('Server not responding - check if it\'s running');
                }
                
                const response = await fetch(`${API_BASE}/network/stats`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const stats = await response.json();
                console.log('Stats loaded:', stats);
                
                // Safely handle missing properties
                const totalInvestors = stats.totalInvestors || 0;
                const totalFirms = stats.totalFirms || 0;
                const withLinkedIn = stats.withLinkedIn || 0;
                const totalPeople = stats.totalPeople || 1; // Avoid division by zero
                const withInvestments = stats.withInvestments || 0;
                
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalInvestors.toLocaleString()}</div>
                        <div class="stat-label">Total Investors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalFirms.toLocaleString()}</div>
                        <div class="stat-label">Investment Firms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(withLinkedIn/totalPeople*100)}%</div>
                        <div class="stat-label">LinkedIn Coverage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${withInvestments.toLocaleString()}</div>
                        <div class="stat-label">Active Investors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #38a169;">${health.status.toUpperCase()}</div>
                        <div class="stat-label">Server Status</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
                document.getElementById('stats').innerHTML = `
                    <div class="error">
                        <strong>API Connection Failed</strong><br>
                        Error: ${error.message}<br>
                        <details style="margin-top: 10px;">
                            <summary>Troubleshooting Steps</summary>
                            <ul style="text-align: left; margin: 10px 0;">
                                <li>Make sure the server is running: <code>node simple_server.js</code></li>
                                <li>Check server is on port 3010</li>
                                <li>View server health: <a href="/health" target="_blank">/health</a></li>
                                <li>View diagnostics: <a href="/api/diagnostics" target="_blank">/api/diagnostics</a></li>
                                <li>Check browser console for errors</li>
                            </ul>
                        </details>
                        <button onclick="loadStats()" style="margin-top: 10px;">Retry Connection</button>
                    </div>`;
            }
        }

        async function searchInvestors() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching investors...</div>';

            try {
                const params = new URLSearchParams();
                const firmName = document.getElementById('firmName').value;
                const minConnections = document.getElementById('minConnections').value;
                const networkTier = document.getElementById('networkTier').value;
                const hasLinkedIn = document.getElementById('hasLinkedIn').value;

                if (firmName) params.append('firm', firmName);
                if (minConnections) params.append('minConnections', minConnections);
                if (networkTier) params.append('networkTier', networkTier);
                if (hasLinkedIn) params.append('hasLinkedIn', hasLinkedIn);
                params.append('limit', '20');

                const response = await fetch(`${API_BASE}/investors/search?${params}`);
                const data = await response.json();

                displayInvestors(data.investors, `Found ${data.count} investors`);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Search failed. Make sure API server is running.</div>';
            }
        }

        async function getTopInvestors() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Loading top investors...</div>';

            try {
                const response = await fetch(`${API_BASE}/investors/search?minConnections=1000&hasLinkedIn=true&limit=20`);
                const data = await response.json();

                displayInvestors(data.investors, 'Top Connected Investors (1000+ connections)');
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Failed to load top investors.</div>';
            }
        }

        function displayInvestors(investors, title) {
            const resultsDiv = document.getElementById('results');
            
            if (!investors || investors.length === 0) {
                resultsDiv.innerHTML = '<div class="error">No investors found matching your criteria.</div>';
                return;
            }

            let html = `<h3>${title}</h3>`;
            
            investors.forEach(investor => {
                html += `
                    <div class="investor-card">
                        <div class="investor-name">${investor.full_name || 'Name not available'}</div>
                        <div class="investor-firm">${investor.firm_name || 'Independent Investor'} ${investor.position ? '| ' + investor.position : ''}</div>
                        <div class="investor-metrics">
                            <span class="metric">üîó ${(investor.first_degree_count || 0).toLocaleString()} connections</span>
                            <span class="metric">üíº ${investor.investment_count || 0} investments</span>
                            <span class="metric">üìä ${investor.data_quality_score || 0}/100 quality</span>
                            <span class="metric">üéØ ${investor.network_tier || 'Unknown'}</span>
                        </div>
                        ${investor.linkedin_url ? `<a href="${investor.linkedin_url}" target="_blank" class="linkedin-link">üîó LinkedIn Profile</a>` : ''}
                        ${investor.headline ? `<div style="margin-top: 10px; color: #718096; font-style: italic;">"${investor.headline}"</div>` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>